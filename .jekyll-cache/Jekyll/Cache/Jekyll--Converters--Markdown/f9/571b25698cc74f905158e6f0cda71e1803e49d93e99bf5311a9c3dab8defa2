I"2…<h2 id="authentication-with-passportjs">Authentication with PassportJS</h2>

<p>PassportJSë¥¼ í†µí•œ authenticationí•˜ëŠ” ë²•ì„ ì•Œì•„ë³´ì. ì¼ë‹¨ í•„ìš”í•œ packagesë“¤ ë¶€í„° ì„¤ì¹˜í•´ë³´ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    npm i --save @nestjs/passport passport passport-local
    npm i --save -D @types/passport-local

</code></pre></div></div>

<p>authëŠ” ë³„ë„ì˜ module ë° ê¸°ëŠ¥ë“¤ì„ ê°€ì§€ë„ë¡ êµ¬í˜„í•´ì¤€ë‹¤. ê·¸ë ‡ì§€ ì•Šê³  ë‹¤ë¥¸ controllerë‚˜ serviceì— ë“¤ì–´ìˆìœ¼ë©´, ë‚˜ì¤‘ì— ì½”ë“œë¥¼ ì†ë³´ê¸°ê°€ ì‰½ì§€ ì•Šê¸° ë•Œë¬¸ì´ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    nest g module auth
    nest g controller auth/controllers/auth
    nest g service auth/services/auth

</code></pre></div></div>
<p>ë¥¼ í†µí•´ì„œ authì— ëŒ€í•œ moduleì„ ë§Œë“¤ì–´ì¤€ë‹¤. ì•„ê¹Œ ì„¤ì¹˜í•œ passport libraryë¥¼ ì‚¬ìš©í•´ authenticationì„ êµ¬í˜„í•  ê²ƒì´ê¸° ë•Œë¬¸ì—, utilsí´ë”ì— LocalStrategy.ts íŒŒì¼ì„ ë§Œë“¤ì–´ì„œ ì–´ë–»ê²Œ authenticationì„ êµ¬í˜„í• ê²ƒì¸ì§€ ì‘ì„±í•œë‹¤.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">Inject</span><span class="p">,</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/common</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">PassportStrategy</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/passport</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">Strategy</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">passport-local</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">AuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/auth/auth.service</span><span class="dl">'</span><span class="p">;</span>

    <span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
    <span class="k">export</span> <span class="kd">class</span> <span class="nx">LocalStrategy</span> <span class="kd">extends</span> <span class="nx">PassportStrategy</span><span class="p">(</span><span class="nx">Strategy</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">(</span>
        <span class="p">@</span><span class="nd">Inject</span><span class="p">(</span><span class="dl">'</span><span class="s1">AUTH_SERVICE</span><span class="dl">'</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">authService</span><span class="p">:</span> <span class="nx">AuthService</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">async</span> <span class="nx">validate</span><span class="p">(</span><span class="nx">username</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">authService</span><span class="p">.</span><span class="nx">validateUser</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>authServiceë¥¼ ë³´ë©´,</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">Inject</span><span class="p">,</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/common</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">UsersService</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">src/users/services/users/users.service</span><span class="dl">'</span><span class="p">;</span>

    <span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
    <span class="k">export</span> <span class="kd">class</span> <span class="nx">AuthService</span> <span class="p">{</span>
        <span class="kd">constructor</span><span class="p">(</span>
            <span class="p">@</span><span class="nd">Inject</span><span class="p">(</span><span class="dl">'</span><span class="s1">USER_SERVICE</span><span class="dl">'</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">userService</span><span class="p">:</span> <span class="nx">UsersService</span><span class="p">,</span>
        <span class="p">)</span> <span class="p">{}</span>

        <span class="k">async</span> <span class="nx">validateUser</span><span class="p">(</span><span class="nx">username</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">userDB</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">userService</span><span class="p">.</span><span class="nx">findUserByUsername</span><span class="p">(</span><span class="nx">username</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">userDB</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">userDB</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

</code></pre></div></div>
<p>ì´ë ‡ê²Œ ì‘ì„±í•˜ê²Œëœë‹¤. ì—¬ê¸°ì„œ ì˜ì•„í•´ì•¼í•  ì ì´ í•˜ë‚˜ìˆë‹¤. í˜„ì¬ ìš°ë¦¬ëŠ” authì— ëŒ€í•œ ê¸°ëŠ¥ì„ êµ¬í˜„ì¤‘ì´ê³ , authServiceëŠ” authì— ëŒ€í•œ ì‹¤ì œ ê¸°ëŠ¥ì´ ì‹¤í–‰ë˜ëŠ” ê³³ì´ë‹¤. ê·¸ëŸ°ë° constructor(@Inject(â€˜USER_SERVICEâ€™) private readonly userService: UsersService)ë¥¼ ë³´ë©´ userServiceë¥¼ í˜„ì¬ serviceì—ì„œ ì‚¬ìš©í•˜ê³  ìˆë‹¤. ë‹¤ë¥¸ serviceëŠ” ë“±ë¡í•´ì£¼ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— ì›ë˜ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤. ê·¸ëŸ¼ ë“±ë¡ì„ í•´ì¤˜ì•¼ë˜ëŠ”ë° ì–´ë””ì„œí•˜ëŠ”ê°€. ìŠì§€ë§ì moduleíŒŒì¼. module íŒŒì¼ì€ controller ë° service, import module ë“±ë“±ì„ ê´€ì¥í•˜ëŠ” íŒŒì¼ì´ë‹¤. ë‹¤ë¥¸ serviceë¥¼ ê°€ì ¸ë‹¤ ì‚¬ìš©í•˜ë ¤ë©´ í˜„ì œ ì‘ì—…ì¤‘ì¸ moduleì— ë¶™ì—¬ì¤˜ì•¼ @Injectë¥¼ í†µí•´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">Module</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/common</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">TypeOrmModule</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/typeorm</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">User</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">src/typeorm</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">AuthController</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./controllers/auth/auth.controller</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">AuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./services/auth/auth.service</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">UsersService</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../users/services/users/users.service</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">PassportModule</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/passport</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">LocalStrategy</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./utils/LocalStrategy</span><span class="dl">'</span><span class="p">;</span>

    <span class="p">@</span><span class="nd">Module</span><span class="p">({</span>
        <span class="na">imports</span><span class="p">:</span> <span class="p">[</span><span class="nx">TypeOrmModule</span><span class="p">.</span><span class="nx">forFeature</span><span class="p">([</span><span class="nx">User</span><span class="p">]),</span> <span class="nx">PassportModule</span><span class="p">],</span>
        <span class="na">controllers</span><span class="p">:</span> <span class="p">[</span><span class="nx">AuthController</span><span class="p">],</span>
        <span class="na">providers</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
            <span class="na">provide</span><span class="p">:</span> <span class="dl">'</span><span class="s1">AUTH_SERVICE</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">useClass</span><span class="p">:</span> <span class="nx">AuthService</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span>
            <span class="na">provide</span><span class="p">:</span> <span class="dl">'</span><span class="s1">USER_SERVICE</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">useClass</span><span class="p">:</span> <span class="nx">UsersService</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="nx">LocalStrategy</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">})</span>
    <span class="k">export</span> <span class="kd">class</span> <span class="nx">AuthModule</span> <span class="p">{}</span>

</code></pre></div></div>

<p>ìœ„ì˜ êµ¬í˜„ëœ ì½”ë“œë¥¼ ë³´ë©´, importsì— TypeOrmModule.forFeature([User]) ê°€ ë¶™ì–´ìˆë‹¤. ì—¬ê¸°ì„  ì‹¤ì œ repositoryì—­í• ì„ í•˜ì§€ ì•ŠëŠ”ë° ì™œ í•„ìš”í•˜ëŠëƒ, userServiceì—ì„œ ì˜ì¡´ì„±ì„ ê°–ê³  ìˆê¸° ë•Œë¬¸ì— userServiceë¥¼ ì‚¬ìš©í•´ì£¼ë ¤ë©´ TypeOrModuleì„ ë¶™ì—¬ì¤˜ì•¼ ì‚¬ìš©ì´ ê°€ëŠ¥í•˜ë‹¤.</p>

<p>ë˜í•œ ë¹¼ë¨¹ìœ¼ë©´ ì•ˆë˜ëŠ”ê²Œ ìš°ë¦¬ê°€ ìƒˆìš´ LocalStrategyì´ë‹¤. ì´ë¥¼ ë¶™ì—¬ì£¼ê¸° ìœ„í•´ import ì•ˆì— PassportModuleì„ ë„£ì–´ì¤€ë‹¤.</p>

<p>userServiceì—ëŠ” authServiceì—ì„œ validatorë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆê²Œ findUserByUsername() í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="nx">findUserByUsername</span><span class="p">(</span><span class="nx">username</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">userRepository</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">username</span> <span class="p">});</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>ë‹¤ ì¤€ë¹„ê°€ ë˜ì—ˆë‹¤ë©´, auth controllerì—ì„œ ì‹¤ì œ urlë¡œ ë°›ì•„ë³¼ ì¤€ë¹„ë¥¼ í•´ë³´ì.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">Controller</span><span class="p">,</span> <span class="nx">Post</span><span class="p">,</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">UseGuards</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/common</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">AuthGuard</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/passport</span><span class="dl">'</span><span class="p">;</span>

    <span class="p">@</span><span class="nd">Controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">auth</span><span class="dl">'</span><span class="p">)</span>
    <span class="k">export</span> <span class="kd">class</span> <span class="nx">AuthController</span> <span class="p">{</span>

        <span class="p">@</span><span class="nd">UseGuards</span><span class="p">(</span><span class="nx">AuthGuard</span><span class="p">(</span><span class="dl">'</span><span class="s1">local</span><span class="dl">'</span><span class="p">))</span>
        <span class="p">@</span><span class="nd">Post</span><span class="p">(</span><span class="dl">'</span><span class="s1">login</span><span class="dl">'</span><span class="p">)</span>
        <span class="k">async</span> <span class="nx">login</span><span class="p">(@</span><span class="nd">Request</span><span class="p">()</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
            
        <span class="p">}</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>postmanì„ í†µí•´ì„œ api requestë¥¼ ë³´ë‚´ë³´ë©´ ì•„ë˜ì™€ê°™ì€ ê²°ê³¼ë¥¼ ë°›ì„ ìˆ˜ ìˆë‹¤.</p>

<p><img src="/img/nest_5/2.png" /></p>

<p>controllerì—ì„œ í•´ë‹¹ urlì— ì•„ë¬´ëŸ° ê¸°ëŠ¥ë„ ì¶”ê°€í•´ì£¼ì§€ ì•Šì•˜ëŠ”ë°, ê°’ì´ return ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ì™œê·¸ëŸ´ê¹Œ?</p>

<p>LocalStrategyê°€ auth.moduleì— ë¶™ì–´ìˆê¸° ë•Œë¬¸ì— validateê°€ ì‹¤í–‰ë˜ê³  validate ì•ˆì—ëŠ” authService.validateUser() í•¨ìˆ˜ê°€ ìˆê¸° ë•Œë¬¸ì— ìë™ìœ¼ë¡œ ì‹¤í–‰ëœ ê²ƒì´ë‹¤. logê°€ ì°íŒê²ƒì„ ë³´ë©´ ì£¼ì–´ì§„ usernameìœ¼ë¡œ ì°¾ì€ user ì •ë³´ê°€ ì°í˜€ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.</p>

<p>@UseGuards(AuthGuard(â€˜localâ€™))ì„ í†µí•´ì„œ ë°”ë¡œ LocalStrategyë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆì—ˆë‹¤.</p>

<p>í˜„ì¬ëŠ” usernameìœ¼ë¡œë§Œ User ì •ë³´ë¥¼ ê°€ì§€ê³  ì˜¤ê³  ìˆë‹¤. passwordê¹Œì§€ ë¹„êµí•´ì„œ user ì •ë³´ë¥¼ ê°€ì§€ê³  ì˜¬ ìˆ˜ ìˆê²Œ ìˆ˜ì •í•´ë³´ì.</p>

<p>auth.service.ts</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">Inject</span><span class="p">,</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/common</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">UsersService</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">src/users/services/users/users.service</span><span class="dl">'</span><span class="p">;</span>

    <span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
    <span class="k">export</span> <span class="kd">class</span> <span class="nx">AuthService</span> <span class="p">{</span>
        <span class="kd">constructor</span><span class="p">(</span>
            <span class="p">@</span><span class="nd">Inject</span><span class="p">(</span><span class="dl">'</span><span class="s1">USER_SERVICE</span><span class="dl">'</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">userService</span><span class="p">:</span> <span class="nx">UsersService</span><span class="p">,</span>
        <span class="p">)</span> <span class="p">{}</span>

        <span class="k">async</span> <span class="nx">validateUser</span><span class="p">(</span><span class="nx">username</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Inside validateUser</span><span class="dl">'</span><span class="p">);</span>

            <span class="kd">const</span> <span class="nx">userDB</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">userService</span><span class="p">.</span><span class="nx">findUserByUsername</span><span class="p">(</span><span class="nx">username</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">userDB</span> <span class="o">&amp;&amp;</span> <span class="nx">userDB</span><span class="p">.</span><span class="nx">password</span> <span class="o">===</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">user validation success!</span><span class="dl">'</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">userDB</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">User Validation Failed!</span><span class="dl">'</span><span class="p">);</span>
            
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>return ëœ ê°’ì€ LocalStrategyë¡œ ê°€ê¸° ë•Œë¬¸ì— í•´ë‹¹ë˜ëŠ” validate functionë„ ìˆ˜ì •í•´ë³´ì.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">Inject</span><span class="p">,</span> <span class="nx">Injectable</span><span class="p">,</span> <span class="nx">UnauthorizedException</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/common</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">PassportStrategy</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/passport</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">Strategy</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">passport-local</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">AuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/auth/auth.service</span><span class="dl">'</span><span class="p">;</span>

    <span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
    <span class="k">export</span> <span class="kd">class</span> <span class="nx">LocalStrategy</span> <span class="kd">extends</span> <span class="nx">PassportStrategy</span><span class="p">(</span><span class="nx">Strategy</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">constructor</span><span class="p">(</span>
            <span class="p">@</span><span class="nd">Inject</span><span class="p">(</span><span class="dl">'</span><span class="s1">AUTH_SERVICE</span><span class="dl">'</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">authService</span><span class="p">:</span> <span class="nx">AuthService</span><span class="p">,</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="k">super</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">async</span> <span class="nx">validate</span><span class="p">(</span><span class="nx">username</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Inside LocalStrategy.validate</span><span class="dl">'</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">username</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">password</span><span class="p">);</span>

            <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">authService</span><span class="p">.</span><span class="nx">validateUser</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">){</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">UnauthorizedException</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">user</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>ì´ë ‡ê²Œ ë°”ê¿”ì£¼ë©´, postmanìœ¼ë¡œ requestë¥¼ ë‚ ë ¸ì„ ë•Œ ì°íˆëŠ” logëŠ” ì•„ë˜ ì‚¬ì§„ê³¼ ê°™ì´ ëœë‹¤.</p>

<p><img src="/img/nest_5/3.png" /></p>

<h2 id="hashing-passwords-with-bcrypt">Hashing Passwords with BCrypt</h2>

<p>hasing í•˜ëŠ” ë²•ì„ ì•Œì•„ë³´ì! ì¼ë‹¨ í•„ìš”í•œ packageë¶€í„° ì„¤ì¹˜í•´ë³´ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    npm install --save @types/bcrypt

</code></pre></div></div>

<p>passwordê°€ inputìœ¼ë¡œ ë“¤ì–´ì˜¤ë©´ ê·¸ëŒ€ë¡œ ì €ì¥í•˜ë©´ ì•ˆë˜ê¸° ë•Œë¬¸ì— bcrypt ê³¼ì •ì„ í†µí•´ ì•”í˜¸í™”í•´ì„œ ì €ì¥í•œë‹¤. ìš°ë¦¬ê°€ ì‘ì„±í•œ íŒŒì¼ì„ ìˆ˜ì •í•´ë³´ì.</p>

<p>ë¨¼ì € controller ë¶€í„° ì ê²€í•´ë³¸ë‹¤. ì–´ë–¤ urlë¡œ ë“¤ì–´ì˜¤ëŠ”ì§€ ë¨¼ì € ì ê²€í•˜ê³  ì‹¤ì œ ê¸°ëŠ¥ì´ êµ¬í˜„ë˜ëŠ” service íŒŒì¼ì„ ë³¸ë‹¤.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="nx">createUser</span><span class="p">(</span><span class="nx">createUserDto</span><span class="p">:</span> <span class="nx">CreateUserDto</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">encodePassword</span><span class="p">(</span><span class="nx">createUserDto</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">password</span><span class="p">);</span>
        
        <span class="kd">const</span> <span class="nx">newUser</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">userRepository</span><span class="p">.</span><span class="nx">create</span><span class="p">({...</span><span class="nx">createUserDto</span><span class="p">,</span> <span class="nx">password</span><span class="p">});</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">newUser</span><span class="p">);</span>
    <span class="p">}</span>

</code></pre></div></div>
<p>ìœ„ì˜ ì½”ë“œë¥¼ ë³´ë©´ createUserDto í˜•ì‹ìœ¼ë¡œ ë“¤ì–´ì˜¨ ë°ì´í„° ì¤‘ passwordë¥¼ êº¼ë‚´ì„œ encodePassword í•´ì£¼ê³  ì‹¤ì œ create dataí• ë•ŒëŠ” encode ëœ passwordë¥¼ ë„£ì–´ì£¼ëŠ” ë°©ì‹ìœ¼ë¡œ ë˜ì–´ìˆë‹¤.</p>

<p>ê·¸ë ‡ë‹¤ë©´ encodePasswordëŠ” ì–´ë–»ê²Œ ë§Œë“¤ê¹Œ?</p>

<p>ë¨¼ì € src/utils/bcrypt.ts íŒŒì¼ì„ ìƒì„±í•œë‹¤. ë‚´ìš©ì€ ì•„ë˜ì™€ ê°™ë‹¤.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">bcrypt</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">bcrypt</span><span class="dl">'</span><span class="p">;</span>

    <span class="k">export</span> <span class="kd">function</span> <span class="nx">encodePassword</span><span class="p">(</span><span class="nx">rawPassword</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">SALT</span> <span class="o">=</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hashSync</span><span class="p">(</span><span class="nx">rawPassword</span><span class="p">,</span> <span class="nx">SALT</span><span class="p">);</span>
    <span class="p">}</span>

</code></pre></div></div>
<p>ë³„ê±´ ì—†ë‹¤. ìˆëŠ” ê·¸ëŒ€ë¡œì˜ bcryptì˜ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì£¼ëŠ” ê²ƒì´ë‹¤. ë“¤ì–´ì˜¨ rawPasswordë¥¼ bcryptë¡œ ì•”í˜¸í™” í•´ì¤€ë’¤ return í•´ì£¼ëŠ”ë° ì—¬ê¸°ì„œ SALTëŠ” ë§ê·¸ëŒ€ë¡œ ì†Œê¸ˆì´ë‹¤. ë°¥ì„ í•  ë•Œ ë°¥ ì§“ëŠ” ë²•ì„ ëª¨ë‘ê°€ ë‹¤ ì•Œê¸° ë•Œë¬¸ì— í•´í‚¹ì— ì·¨ì•½í•  ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ ë‚˜ì˜ ì…ë§›ì— ë§ê²Œ ë‚˜ë§Œì˜ saltë¥¼ ì¶”ê°€í•´ì„œ í•´í‚¹ì„ ë°©ì§€í•˜ê³ ì ë“¤ì–´ê°€ ìˆëŠ” ê²ƒì´ë‹¤.</p>

<p>postmanì—ì„œ urlë¡œ requestë¥¼ ë‚ ë ¤ì£¼ë©´, ì•„ë˜ì™€ ê°™ì´ ì‹¤í–‰ë¨ì„ ë³¼ ìˆ˜ ìˆë‹¤.</p>

<p><img src="/img/nest_5/1.png" /></p>

<p>ì´ì œ ì´ì „ì— passportë¥¼ ì—°ê²°í•˜ë˜ authë¥¼ ì‹¤ì œ ì…ë ¥ìœ¼ë¡œ ë“¤ì–´ì˜¨ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¹„êµí•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ hashëœ ë¹„ë°€ë²ˆí˜¸ì˜ ë¹„êµë¥¼ í†µí•´ì„œ ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ êµ¬í˜„í•´ë³´ì.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">export</span> <span class="kd">function</span> <span class="nx">comparePasswords</span><span class="p">(</span><span class="nx">rawPassword</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">hash</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">compareSync</span><span class="p">(</span><span class="nx">rawPassword</span><span class="p">,</span> <span class="nx">hash</span><span class="p">);</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>ì‹¤ì œ ë¡œê·¸ì¸ í•¨ìˆ˜ê°€ êµ¬í˜„ë˜ëŠ” auth.service êµ¬í˜„ì€</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">Inject</span><span class="p">,</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/common</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">UsersService</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">src/users/services/users/users.service</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">comparePasswords</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">src/utils/bcrypt</span><span class="dl">'</span><span class="p">;</span>

    <span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
    <span class="k">export</span> <span class="kd">class</span> <span class="nx">AuthService</span> <span class="p">{</span>
        <span class="kd">constructor</span><span class="p">(</span>
            <span class="p">@</span><span class="nd">Inject</span><span class="p">(</span><span class="dl">'</span><span class="s1">USER_SERVICE</span><span class="dl">'</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">userService</span><span class="p">:</span> <span class="nx">UsersService</span><span class="p">,</span>
        <span class="p">)</span> <span class="p">{}</span>

        <span class="k">async</span> <span class="nx">validateUser</span><span class="p">(</span><span class="nx">username</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Inside validateUser</span><span class="dl">'</span><span class="p">);</span>

            <span class="kd">const</span> <span class="nx">userDB</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">userService</span><span class="p">.</span><span class="nx">findUserByUsername</span><span class="p">(</span><span class="nx">username</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">userDB</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">matched</span> <span class="o">=</span> <span class="nx">comparePasswords</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">userDB</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">matched</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">user validation success!</span><span class="dl">'</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">userDB</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">passwords do not matched</span><span class="dl">"</span><span class="p">);</span>
                <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">User Validation Failed!</span><span class="dl">'</span><span class="p">);</span>
            
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>ì´ë ‡ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.</p>

<p>base_url/api/auth/login ìœ¼ë¡œ postman requestë¥¼ ë‚ ë ¤ì£¼ë©´, auth controllerì—ëŠ” loginì— ëŒ€í•´ì„œ serviceë‚˜ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ì§€ ì•Šì•˜ì§€ë§Œ, ìœ„ì— ë¶™ì€ @UseGuards(AuthGuard(â€˜localâ€™)) ì„ í†µí•´ì„œ ë°”ë¡œ LocalStrategyë¡œ ë“¤ì–´ê°€ê²Œ ë˜ê³ , êµ¬í˜„ëœ validate í•¨ìˆ˜ë¡œ ì‹¤ì œ ë¡œê·¸ì¸í•œ íšŒì›ì´ ì‹¤ì œ íšŒì›ì´ ë§ëŠ”ì§€ ê²€í† í•œë‹¤.</p>

<p>ì—¬ê¸°ì„œ authServiceë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ê³ , authService ë‚´ì— êµ¬í˜„ëœ userServiceë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ moduleì— providerë¥¼ ë¶™ì—¬ì¤€ ê²ƒì´ë‹¤.</p>

<p>ì„œë¡œ íŒŒì¼ë“¤ì´ ì—‰í‚¤ê³  ì—‰ê²¨ ìˆì§€ë§Œ í•˜ë‚˜ì”© ë“¤ì—¬ë‹¤ ë³´ë©´ ê·¸ë ‡ê²Œ ë˜ ë§‰ ì–´ë µì§€ëŠ” ì•Šë‹¤. ì´ì œ ì¡°ê¸ˆë§Œ ë”í•˜ë©´ tutorialì€ ëë‚  ê²ƒ ê°™ìœ¼ë‹ˆ, ì–¼ë¥¸ ìƒˆë¡œìš´ ì‹¤ì œ toy í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•´ë³´ì.</p>
:ET