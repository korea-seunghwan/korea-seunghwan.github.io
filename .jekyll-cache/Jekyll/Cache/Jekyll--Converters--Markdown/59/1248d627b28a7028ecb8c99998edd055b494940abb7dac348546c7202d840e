I" G<h2 id="middleware">Middleware</h2>

<p>customersì— middleware í´ë” ì¶”ê°€ ë° validate-customer.middleware.ts íŒŒì¼ ìƒì„±</p>

<p>middlewareëŠ” expressë¥¼ ë‹¤ë£° ë•Œ ì¨ë´ì„œ ì–´ë–»ê²Œ ëŒì•„ê°€ëŠ”ì§€ ì›ë¦¬ëŠ” ì•Œê³  ìˆë‹¤. middlewareëŠ” ì‰½ê²Œ ì„¤ëª…í•˜ë©´ í•´ë‹¹ urlë¡œ ë“¤ì–´ì™€ serviceì— êµ¬í˜„ë˜ì–´ìˆëŠ” ë¡œì§ì„ ìˆ˜í–‰í•˜ê¸° ì´ì „ì— ìˆ˜í–‰ë˜ëŠ” ë¡œì§ì´ë¼ê³  ìƒê°í•˜ë©´ í¸í•˜ë‹¤.</p>

<p>expressì—ì„œëŠ” ë¹„êµì  middleware ì‚¬ìš©ì´ ì‰½ê³  ê°„ë‹¨í–ˆëŠ”ë°, nestjsì—ì„œëŠ” expressë³´ë‹¤ëŠ” ì¡°ê¸ˆ ë” ë³µì¡í•˜ê²Œ ì‚¬ìš©í•´ì•¼ í•œë‹¤.</p>

<p>ì¼ë‹¨ ìƒì„±í•œ validate-customer.middleware.tsíŒŒì¼ì„ ë³´ë©´,</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span><span class="p">,</span> <span class="nx">NestMiddleware</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@nestjs/common</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">NextFunction</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">express</span><span class="dl">"</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ValidateCustomerMiddleware</span> <span class="k">implements</span> <span class="nx">NestMiddleware</span> <span class="p">{</span>
  <span class="nx">use</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hello, world. Iam inside ValidateCustomerMiddleware!</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>@Injectable() annotationì„ ë¶™ì—¬ì£¼ì—ˆê³ , NestMiddlewareë¼ëŠ” interfaceë¥¼ êµ¬í˜„í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤. ë‚´ë¶€ëŠ” use()í•¨ìˆ˜ê°€ êµ¬í˜„ë˜ì–´ ìˆëŠ”ë° êµ¬ì„±ì„ ë³´ë©´,
req, res ë‹¤ ì‚¬ìš©ê°€ëŠ¥í•˜ê³  ì—¬ê¸°ì„œ nextëŠ” middlewareë¥¼ ê±°ì³ ì‹¤ì œ urlì—ì„œ ìˆ˜í–‰ë˜ì–´ì•¼ í•˜ëŠ” ë¡œì§ì„ ì˜ë¯¸í•œë‹¤.
ì´ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” module íŒŒì¼ì— ë¶™ì—¬ì£¼ëŠ” ì‘ì—…ì´ í•„ìš”í•˜ë‹¤.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span>
  <span class="nx">MiddlewareConsumer</span><span class="p">,</span>
  <span class="nx">Module</span><span class="p">,</span>
  <span class="nx">NestModule</span><span class="p">,</span>
  <span class="nx">RequestMethod</span><span class="p">,</span>
<span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@nestjs/common</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">CustomersController</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./controllers/customers/customers.controller</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">ValidateCustomerMiddleware</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./middlewares/validate-customer.middleware</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">CustomersService</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./services/customers/customers.service</span><span class="dl">"</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Module</span><span class="p">({</span>
  <span class="na">controllers</span><span class="p">:</span> <span class="p">[</span><span class="nx">CustomersController</span><span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">CustomersService</span><span class="p">],</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">CustomersModule</span> <span class="k">implements</span> <span class="nx">NestModule</span> <span class="p">{</span>
  <span class="nx">configure</span><span class="p">(</span><span class="nx">consumer</span><span class="p">:</span> <span class="nx">MiddlewareConsumer</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">consumer</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ValidateCustomerMiddleware</span><span class="p">).</span><span class="nx">forRoutes</span><span class="p">({</span>
      <span class="na">path</span><span class="p">:</span> <span class="dl">"</span><span class="s2">customers/search/:id</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">method</span><span class="p">:</span> <span class="nx">RequestMethod</span><span class="p">.</span><span class="nx">GET</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>moduleíŒŒì¼ì˜ ì“°ì„ìƒˆê°€ ì—¬ê¸°ì„œ ë„ë“œë¼ì§€ê²Œ ë‚˜íƒ€ë‚œë‹¤ ê¸°ì¡´ì—ëŠ” ê·¸ëƒ¥ serviceë¥¼ ë¶™ì—¬ì£¼ëŠ” ê³³ìœ¼ë¡œë§Œ ìƒê°í–ˆëŠ”ë° middlewareë„ ì—¬ê¸°ì„œ ë¶™ì—¬ì¤„ ìˆ˜ ìˆë‹¤.</p>

<p>NestModuleì´ë¼ëŠ” interfaceë¥¼ êµ¬í˜„í•˜ê³  ìˆìœ¼ë©° configure í•¨ìˆ˜ ë‚´ë¶€ì— apply í•¨ìˆ˜ë¡œ ìš°ë¦¬ê°€ ì‘ì„±í–ˆë˜ ValidateCustomerMiddlewareë¥¼ ë¶™ì—¬ì£¼ê³  .forRoutes({})ë¡œ middlewareë¥¼ ì„¤ì •í•´ ì¤„ pathë„ ì„¤ì •ì´ ê°€ëŠ¥í•˜ë‹¤.</p>

<p>í˜„ì¬ëŠ” â€˜customers/search/:idâ€™ ì—ë‹¤ê°€ë§Œ middlewareë¥¼ ë¶™ì—¬ì£¼ì—ˆê³ , ì‹¤ì œ postmanìœ¼ë¡œ testí•´ë³´ë©´</p>

<p><img src="/img/nest_3/1.png" width="100%" /></p>

<p><img src="/img/nest_3/2.png" /></p>

<p>ì´ë ‡ê²Œ ê²°ê³¼ê°€ ë‚˜ì˜¤ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. middlewareë¥¼ ë“¤ë ¸ë‹¤ ì™”ë‹¤ëŠ” ì¦ê±°ë¡œ ì €ë ‡ê²Œ consoleì— logê°€ ì°íˆê²Œ ë˜ëŠ” ê²ƒì´ë‹¤.</p>

<p>ì¶”í›„ì— JWTTokenì„ í†µí•´ì„œ ë¡œê·¸ì¸ í™•ì¸ì„ í•  ë•Œ middlewareë¥¼ ë§ì´ ì‚¬ìš©í•˜ê²Œ ë˜ëŠ”ë° ìœ ìš©í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ë‹¤.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Module</span><span class="p">({</span>
  <span class="na">controllers</span><span class="p">:</span> <span class="p">[</span><span class="nx">CustomersController</span><span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">CustomersService</span><span class="p">],</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">CustomersModule</span> <span class="k">implements</span> <span class="nx">NestModule</span> <span class="p">{</span>
  <span class="nx">configure</span><span class="p">(</span><span class="nx">consumer</span><span class="p">:</span> <span class="nx">MiddlewareConsumer</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// consumer.apply(ValidateCustomerMiddleware).forRoutes(</span>
    <span class="c1">//   {</span>
    <span class="c1">//     path: 'customers/search/:id',</span>
    <span class="c1">//     method: RequestMethod.GET,</span>
    <span class="c1">//   },</span>
    <span class="c1">//   {</span>
    <span class="c1">//     path: 'customers/:id',</span>
    <span class="c1">//     method: RequestMethod.GET,</span>
    <span class="c1">//   },</span>
    <span class="c1">// );</span>
    <span class="nx">consumer</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ValidateCustomerMiddleware</span><span class="p">).</span><span class="nx">forRoutes</span><span class="p">(</span><span class="nx">CustomersController</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ì´ë ‡ê²Œ controllerë¥¼ í†µì§¸ë¡œ ë¶™ì—¬ì£¼ë©´ controllerì— ì†í•˜ëŠ” ëª¨ë“  routeë“¤ì— middlewareë¥¼ ë¶™ì—¬ì¤„ ìˆ˜ ìˆë‹¤.</p>

<p>exclude í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ ì „ì²´ì¤‘ì— ì œì™¸ì‹œí‚¬ ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ë©´,</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span><span class="p">,</span> <span class="nx">NestMiddleware</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@nestjs/common</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">NextFunction</span><span class="p">,</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">Response</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">express</span><span class="dl">"</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ValidateCustomerMiddleware</span> <span class="k">implements</span> <span class="nx">NestMiddleware</span> <span class="p">{</span>
  <span class="nx">use</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hello, world. Iam inside ValidateCustomerMiddleware!</span><span class="dl">"</span><span class="p">);</span>

    <span class="kd">const</span> <span class="p">{</span> <span class="nx">authorization</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">authorization</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">res</span>
        <span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">"</span><span class="s2">No Authentication Token Provided</span><span class="dl">"</span> <span class="p">});</span>

    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ì²˜ëŸ¼ headerì—ì„œ authorizationìœ¼ë¡œ jwtTokenì„ ë°›ê³ , tokenì´ ê°™ì´ ë„˜ì–´ì˜¤ì§€ ì•ŠëŠ”ë‹¤ë©´, next() functionìœ¼ë¡œ ë„˜ì–´ê°€ì„œ í•´ë‹¹ urlì— service ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ë°”ë¡œ returní•´ì„œ authenticationì´ ì œëŒ€ë¡œ ë˜ì§€ ì•Šì•˜ë‹¤ê³  ì•Œë ¤ì¤€ë‹¤.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="k">if</span> <span class="p">(</span><span class="nx">authorization</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span>
      <span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Invalid Authentication Token Provided.</span><span class="dl">"</span> <span class="p">});</span>
  <span class="p">}</span>
  
</code></pre></div></div>
<p>ì´ëŸ°ì‹ìœ¼ë¡œ ë“¤ì–´ì˜¨ authorizationì„ ê²€í† í•´ì„œ ì¡°ê±´ì— ë§ê²Œ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆë‹¤. ë¬¼ë¡  ì‹¤ì œ ë¡œê·¸ì¸ ì²´í¬ë¥¼ í•  ë•ŒëŠ” ìœ„ì˜ ì½”ë“œì²˜ëŸ¼ í•˜ì§€ ì•ŠëŠ”ë‹¤.</p>

<p>ìƒˆë¡œìš´ middleware íŒŒì¼ valid-customer-account.middleware.tsì„ ë§Œë“¤ì–´ë³´ì.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span><span class="p">,</span> <span class="nx">NestMiddleware</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/common</span><span class="dl">'</span><span class="p">;</span>
  <span class="k">import</span> <span class="p">{</span> <span class="nx">NextFunction</span><span class="p">,</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">Response</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
  <span class="k">export</span> <span class="kd">class</span> <span class="nx">ValidateCustomerAccount</span> <span class="k">implements</span> <span class="nx">NestMiddleware</span> <span class="p">{</span>
    <span class="nx">use</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">valid</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">valid</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">next</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Account is invalid</span><span class="dl">'</span> <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

</code></pre></div></div>

<p>ì—¬ëŸ¬ê°œì˜ middlewareë¥¼ ì ìš©ì‹œì¼œ ì¤„ë•ŒëŠ” module íŒŒì¼ì—ì„œ ê·¸ëƒ¥ , ì°ê³  ë¶™ì—¬ì£¼ë©´ ëœë‹¤.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="k">export</span> <span class="kd">class</span> <span class="nx">CustomersModule</span> <span class="k">implements</span> <span class="nx">NestModule</span> <span class="p">{</span>
    <span class="nx">configure</span><span class="p">(</span><span class="nx">consumer</span><span class="p">:</span> <span class="nx">MiddlewareConsumer</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">consumer</span>
        <span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ValidateCustomerMiddleware</span><span class="p">,</span> <span class="nx">ValidateCustomerAccount</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">forRoutes</span><span class="p">(</span>
          <span class="p">{</span>
            <span class="na">path</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers/search/:id</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">method</span><span class="p">:</span> <span class="nx">RequestMethod</span><span class="p">.</span><span class="nx">GET</span><span class="p">,</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="na">path</span><span class="p">:</span> <span class="dl">'</span><span class="s1">customers/:id</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">method</span><span class="p">:</span> <span class="nx">RequestMethod</span><span class="p">.</span><span class="nx">GET</span><span class="p">,</span>
          <span class="p">},</span>
        <span class="p">);</span>
      <span class="c1">// consumer.apply(ValidateCustomerMiddleware).forRoutes(CustomersController);</span>
    <span class="p">}</span>
  <span class="p">}</span>

</code></pre></div></div>

<p>ì´ë ‡ê²Œ ë˜ë©´ ë¨¼ì € ë¶™ì—¬ì¤€ ValidateCustomerMiddlewareë¥¼ ë“¤ë¦¬ê³  ì¶©ì¡±í•œë‹¤ë©´ next() functionì„ í†µí•´ ValidateCustomerAccountë¡œ ë“¤ì–´ê°€ê²Œ ëœë‹¤. ValidateCustomerAccountê¹Œì§€ í†µê³¼í•´ì•¼ë§Œ í•´ë‹¹ urlì˜ service ê¸°ëŠ¥ê¹Œì§€ ê°ˆ ìˆ˜ ìˆë‹¤.</p>

<p>ì—¬ê¸°ê¹Œì§€í•´ì„œ Middlewareì¥ì„ ë§ˆì¹˜ë„ë¡ í•˜ê² ë‹¤.</p>

<p>MiddlewareëŠ” ì‰½ê²Œ ìƒê°í•´ì„œ controllerì˜ urlì— ê³µí†µì ìœ¼ë¡œ ë¨¼ì € ì²´í¬í•´ì•¼ë˜ëŠ” ê¸°ëŠ¥ì„ ê±°ì³ì„œ urlë¡œ ì ‘ì†í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” filterì •ë„ë¡œ ìƒê°í•˜ë©´ ëœë‹¤.</p>
:ET